# NG 102 エラー分析レポート

## エラーの意味

NG 102 = **送信異常(次送信可能時間待ち)**

これは、ES920LR3 が**オペレーションモード**で送信待ち状態にあることを示します。
設定モードに入れていないため、設定コマンド（「2」「v」など）が実行できません。

## 現在の状況

### ログ分析

```
=== Step 1: Enter Configuration Mode ===
[TX] 2
[RX] (no response)  ← 「2」コマンドに応答がない

=== Step 2: Module Communication Test ===
[TX] v
[RX] 8 bytes: NG 102\r\n  ← オペレーションモードの送信待ち状態
```

### 問題点

1. **「2」コマンドに応答がない** → モジュールが設定モードに入れていない
2. **NG 102 が返される** → オペレーションモードで送信待ち状態
3. **設定モードへの移行が失敗している**

## ES920LR3 の動作モード

ES920LR3 には以下のモードがあります：

1. **設定モード（Configuration Mode）**: コマンドで設定を変更可能
2. **オペレーションモード（Operation Mode）**: LoRaWAN 通信を実行

### 設定モードへの移行手順（仕様書より）

1. **boot_pin を HIGH に設定** → 設定モードに入る準備
2. **リセット実行** → モジュールをリセット
3. **シリアル通信確立** → UART で通信開始
4. **「2」コマンド送信** → プロセッサーモード選択
5. **応答確認** → 設定モードに入ったことを確認

## 考えられる原因

### 1. boot_pin の制御タイミング

- boot_pin を HIGH にしてからリセットするまでの時間が不足
- リセット後、boot_pin が HIGH のまま維持されていない

### 2. リセット後の待機時間不足

- モジュールの起動に時間がかかる
- ULSA M5B 接続時は起動が遅れる可能性

### 3. シリアル通信の確立タイミング

- モジュールが完全に起動する前にシリアル通信を開始
- バッファクリアが不十分

### 4. ULSA M5B との干渉

- M-BUS 経由で接続された ULSA M5B が何らかの干渉を発生
- GPIO22（boot_pin）や GPIO19（reset_pin）への影響

## 解決策

### 1. boot_pin の制御を確実にする

- boot_pin を HIGH に設定してから、十分な時間待機してからリセット
- リセット後も boot_pin を HIGH のまま維持

### 2. リセット後の待機時間を延長

- モジュールの起動を待つ（500ms 以上推奨）
- ULSA M5B 接続時は更に長い待機時間が必要

### 3. 「2」コマンドの応答を待つ

- 応答がない場合、モジュールが既にオペレーションモードに入っている可能性
- その場合、一度オペレーションモードから抜ける必要がある

### 4. オペレーションモードからの脱出

- モジュールがオペレーションモードに入っている場合、強制的にリセットして設定モードに入る
- boot_pin を HIGH にしてリセットを複数回試行

## 推奨される修正

1. **boot_pin 制御の改善**

   - boot_pin を HIGH に設定後、100ms 待機してからリセット
   - リセット後、boot_pin を HIGH のまま維持

2. **リセット後の待機時間延長**

   - リセット後、500ms 以上待機
   - ULSA M5B 接続時は 1000ms 待機

3. **「2」コマンドの再試行**

   - 応答がない場合、複数回再試行
   - 各試行の間に待機時間を設ける

4. **オペレーションモードからの脱出**
   - 「2」コマンドに応答がない場合、モジュールを強制的にリセット
   - boot_pin を HIGH にしてリセットを複数回試行
