# 「2」コマンド応答なし問題の分析

## 問題の本質

**「2」コマンドに応答が返ってこない**ことが根本的な問題です。

NG 102 エラーは結果であり、原因は「モジュールが設定モードに入れていない」または「シリアル通信が確立されていない」ことです。

## ES920LR3 の設定モードへの移行手順（仕様書より）

1. **boot_pin を HIGH に設定** → 設定モードに入る準備
2. **リセット実行** → モジュールをリセット
3. **シリアル通信確立** → UART で通信開始（115200bps, 8N1）
4. **モジュール起動待ち** → 起動完了を待つ
5. **「Select Mode [1:Processor, 2:External]」プロンプト表示** → 設定モードに入った証拠
6. **「2」コマンド送信** → プロセッサーモード選択
7. **応答確認** → 「OK」または設定モードのプロンプトが返る

## 「2」コマンドに応答がない原因

### 1. モジュールが設定モードに入っていない

**考えられる原因：**

- boot_pin の制御タイミングが不適切
- リセットのタイミングが悪い
- モジュールが起動していない
- boot_pin が HIGH のまま維持されていない

**確認方法：**

- boot_pin の状態をログ出力で確認
- リセット後の待機時間を延長
- モジュールの起動プロンプト（「Select Mode...」）が表示されるか確認

### 2. シリアル通信が確立されていない

**考えられる原因：**

- ボーレート不一致（115200bps）
- ピン接続不良（GPIO32/33）
- TX/RX の接続が逆
- Serial1.setTimeout(50)が短すぎる
- ULSA M5B との干渉

**確認方法：**

- シリアル通信の設定を確認
- モジュール起動時のプロンプトが受信できるか確認
- ループバックテストで通信を確認

### 3. モジュールが起動していない

**考えられる原因：**

- 電源供給不足
- リセット後の待機時間不足
- モジュールが故障している
- ULSA M5B 接続時の電源不足

**確認方法：**

- 電源電圧を測定
- リセット後の待機時間を延長
- ULSA M5B を外して動作確認

### 4. sendCommand 関数の問題

**現在の実装：**

```cpp
delay(100);
String resp = Serial1.readString(); // Serial1.setTimeout(50)が設定されている
```

**問題点：**

- Serial1.setTimeout(50)が短すぎる可能性
- readString()はタイムアウトまで待つが、モジュールの応答が遅れる可能性
- モジュール起動時のプロンプトを読み逃している可能性

## 解決策

### 1. モジュール起動プロンプトの確認

ES920LR3 は設定モードに入ると「Select Mode [1:Processor, 2:External]」というプロンプトを表示します。
このプロンプトが受信できているか確認する必要があります。

### 2. シリアル通信のタイムアウト設定の見直し

Serial1.setTimeout(50)は短すぎる可能性があります。
モジュールの起動には時間がかかるため、タイムアウトを延長する必要があります。

### 3. モジュール起動プロンプトの待機

「2」コマンドを送信する前に、モジュールの起動プロンプトが表示されるまで待つ必要があります。

### 4. シリアル通信の確立確認

シリアル通信が正しく確立されているか、モジュールからのデータが受信できるか確認する必要があります。

## 推奨される修正

1. **Serial1.setTimeout()の延長**: 50ms → 1000ms 以上
2. **モジュール起動プロンプトの待機**: 「Select Mode...」が表示されるまで待つ
3. **シリアル通信の確立確認**: モジュールからのデータが受信できるか確認
4. **デバッグ情報の追加**: 受信した生データを表示
