# NG 102 エラー調査レポート

## 問題の概要

M5Stack Core2 の M-BUS に別のセンサを取り付けつつ、GROVE 端子（PORT.A）接続による LoRaWAN 通信（ES920LR3）を実行すると、NG 102 エラーが発生する。

## エラーの発生状況

### コンソールログ

```
=== Step 1: Enter Configuration Mode ===
Selecting processor mode (2)...
[TX] 2
[RX] (no response)

=== Step 2: Module Communication Test ===
Attempt 1/3
[TX] v
[RX] 8 bytes: NG 102\r\n
Attempt 2/3
[TX] v
[RX] 8 bytes: NG 102\r\n
Attempt 3/3
[TX] v
[RX] 8 bytes: NG 102\r\n
```

### 観察事項

1. Step 1 の「2」コマンド（プロセッサーモード選択）に応答がない
2. Step 2 の「v」コマンド（バージョン確認）に対して NG 102 が返される
3. NG 102 は設定モードでない状態でコマンドを実行しようとした際に発生する可能性が高い

## 現在の実装状況

### ピン割り当て

- **GROVE PORT.A（ES920LR3 通信）**: GPIO32（TX）、GPIO33（RX）、Serial1 を使用
- **boot_pin**: GPIO22（設定モード/オペレーションモード切り替え）
- **reset_pin**: GPIO19（モジュールリセット）
- **M-BUS**: Serial2 を使用（GPIO13/14 または GPIO16/17 の可能性）

### コードの動作フロー

1. `boot_pin`を HIGH にして設定モードに入る
2. `LoRa_Reset()`でモジュールをリセット
3. Serial1 を初期化（GPIO32/33、115200bps、8N1）
4. 「2」コマンドでプロセッサーモード選択
5. 「v」コマンドでバージョン確認

## 考えられる原因

### 1. ピン競合の可能性

- **M-BUS と GROVE 端子のピン競合**: M-BUS に接続されたセンサが、GPIO22（boot_pin）や GPIO19（reset_pin）に影響を与えている可能性
- **I2C バスとの競合**: M-BUS は通常 I2C バスを使用するが、GPIO32/33 が I2C としても使用されている可能性
  - コードでは`cfg.external_rtc = false`で I2C 機能を無効化しているが、M-BUS 接続時に再び有効化されている可能性

### 2. 電源供給の問題

- M-BUS に接続されたセンサと ES920LR3 の両方に電源を供給する際、電源が不足している可能性
- ES920LR3 は通信時に高い電流を消費する可能性がある

### 3. モジュールの状態遷移の問題

- `boot_pin`の制御が正しく動作していない可能性
- リセット後の待機時間が不足している可能性
- モジュールがオペレーションモードのまま設定モードに移行できていない

### 4. シリアル通信のタイミング問題

- モジュールの初期化が完了する前にコマンドを送信している可能性
- バッファクリアが不十分な可能性

## NG 102 エラーの意味

ES920LR3 の仕様書によると、NG 102 は以下の可能性がある：

- **設定モードでない状態でコマンドを実行しようとした**
- **モジュールが正しく初期化されていない**
- **コマンドの実行条件が満たされていない**

## 調査が必要な項目

### 1. M-BUS のピン割り当て確認

- M-BUS が使用する GPIO ピンを特定
- GPIO22、GPIO19、GPIO32、GPIO33 との競合がないか確認

### 2. M-BUS 接続センサの動作確認

- M-BUS に接続されたセンサがどのピンを使用しているか
- センサが GPIO22 や GPIO19 を制御していないか

### 3. 電源供給の確認

- M-BUS 接続時と非接続時での電源電圧の測定
- ES920LR3 の動作電圧の確認

### 4. boot_pin と reset_pin の動作確認

- GPIO22 と GPIO19 が正しく制御できているか
- オシロスコープやロジックアナライザーでの信号確認

### 5. シリアル通信の詳細確認

- 送受信データの詳細なログ取得
- タイミングチャートの確認

## 推奨される対処方法

### 即座に試すべき対処

1. **M-BUS 接続を外して動作確認**: M-BUS に接続されたセンサを外し、ES920LR3 のみで動作するか確認
2. **boot_pin と reset_pin の制御タイミング調整**: リセット後の待機時間を延長
3. **シリアル通信のバッファクリア強化**: より確実にバッファをクリア

### 根本的な解決策

1. **ピン割り当ての見直し**: M-BUS と GROVE 端子のピン競合を回避する設計変更
2. **電源供給の強化**: 外部電源の使用を検討
3. **モジュール初期化シーケンスの改善**: より確実な初期化手順の実装

## 次のステップ

1. M-BUS 接続時のピン状態を確認するデバッグコードの追加
2. boot_pin と reset_pin の制御を詳細にログ出力
3. M-BUS 接続センサの仕様確認
4. 段階的な動作確認（M-BUS 接続なし → 接続あり）
