# ES920LR3 コマンド応答遅延問題の解決策

## 問題の概要

M-BUS 接続時に、ES920LR3 へのコマンド応答が極端に遅くなる問題が発生しています。
通常 1 コマンド数 ms の応答が、delay 500ms の 3-4 回リトライが必要になり、2000ms 程度でようやく成功する状況です。

## 根本原因の分析

### 1. UART コントローラーの競合

ESP32 には 3 つの UART コントローラー（UART0, UART1, UART2）がありますが、以下の問題が考えられます：

- **Serial1（ES920LR3）**: UART1 を使用、GPIO32/33
- **Serial2（M-BUS）**: UART2 を使用、GPIO13/14
- **ULSA M5B の recvUART タスク**: 優先度 3（最高）で CPU Core 1 で動作し、常に Serial2 からデータを受信

### 2. 割り込みの競合

- Serial2 の受信割り込みが頻繁に発生し、Serial1 の処理を妨げている可能性
- ESP32 の UART 割り込みは共有リソースを使用しているため、複数の UART が同時に動作すると干渉が発生

### 3. バッファオーバーフロー

- Serial2 の受信バッファ（デフォルト 256 バイト）が満杯になると、UART コントローラーに負荷がかかる
- ULSA M5B からのデータが頻繁に送信される場合、バッファが常に満杯状態になる可能性

## 実装済みの対策

### 1. Serial2 の受信バッファの定期的なクリア

```cpp
void pauseSerial2Reception() {
  while (Serial2.available()) {
    Serial2.read();
  }
  delayMicroseconds(100);
}
```

- コマンド送信前に Serial2 の受信バッファをクリア
- UART コントローラーへの負荷を軽減

### 2. コマンド送信中の Serial2 処理の最適化

```cpp
// Serial2のバッファクリア間隔を20msに設定
const uint32_t serial2ClearInterval = 20;
```

- 頻繁すぎるバッファクリアを避け、適切な間隔でクリア
- コマンド送信中の待機時間を 10ms に短縮して応答性を向上

### 3. GPIO ピンの設定最適化

```cpp
pinMode(RX_pin, INPUT_PULLUP); // GPIO33: Serial1 RX
pinMode(TX_pin, OUTPUT);        // GPIO32: Serial1 TX
```

- Serial1 の GPIO ピンのプルアップ設定を明示的に指定
- ノイズによる誤動作を防止

## 追加の推奨対策

### 1. ULSA M5B 側の修正（推奨度: ★★★★★）

**最も効果的な解決策**: ULSA M5B の`recvUART`タスクを修正し、ES920LR3 のコマンド送信中は一時停止する機能を追加

```cpp
// ULSA M5B側に追加するコード例
volatile bool pauseSerial2Reception = false;

void recvUART(void *pvParameters) {
  while (1) {
    if (!pauseSerial2Reception) {
      if (xSemaphoreTake(xMutex, portMAX_DELAY) == pdTRUE) {
        recvData();
        xSemaphoreGive(xMutex);
      }
    }
    delay(1);
  }
}
```

**ES920LR3 側から制御する方法**:

- 共有メモリまたはグローバル変数を使用
- FreeRTOS のセマフォまたはイベントグループを使用

### 2. UART 割り込み優先度の調整（推奨度: ★★★★）

ESP32 の UART 割り込み優先度を調整することで、Serial1 の処理を優先させる

```cpp
// platformio.iniに追加
build_flags =
    -DARDUINO_ESP32_DEV
    -DCONFIG_UART_ISR_IN_IRAM=1
```

### 3. ハードウェア的な対策（推奨度: ★★★）

#### 3.1 プルアップ/プルダウン抵抗の追加

- GPIO32/33 に外部プルアップ抵抗（10kΩ）を追加
- ノイズによる誤動作を防止

#### 3.2 電源の分離

- ES920LR3 と M-BUS の電源を分離
- 電源ノイズによる干渉を防止

#### 3.3 シールドケーブルの使用

- M-BUS ケーブルをシールドケーブルに変更
- 電磁干渉を軽減

### 4. ソフトウェア的な最適化（推奨度: ★★★）

#### 4.1 コマンド送信タイミングの最適化

```cpp
// M-BUSのデータ送信間隔を確認し、その間隙にコマンドを送信
// ULSA M5Bのデータ送信間隔が分かっている場合、その間隙を利用
```

#### 4.2 バッファサイズの調整

```cpp
// platformio.iniに追加（Arduino ESP32では直接設定できないが、コンパイル時オプションで調整可能）
build_flags =
    -DCONFIG_UART_RX_BUFFER_SIZE=128
```

### 5. 代替案（推奨度: ★★）

#### 5.1 別の UART ポートの使用

- Serial1 の代わりに、ハードウェアシリアルを使用
- ただし、M5Stack Core2 では利用可能な UART ポートが限られている

#### 5.2 ソフトウェアシリアルの使用

- ハードウェア UART の代わりにソフトウェアシリアルを使用
- ただし、パフォーマンスが低下する可能性

## テスト方法

### 1. 単体テスト

1. M-BUS 未接続時: ES920LR3 へのコマンド応答時間を測定
2. M-BUS 接続時: ES920LR3 へのコマンド応答時間を測定
3. 比較: 応答時間の差を確認

### 2. 統合テスト

1. ULSA M5B と ES920LR3 を同時に動作
2. コマンド送信の成功率を測定
3. NG 102 エラーの発生頻度を確認

### 3. 負荷テスト

1. 長時間動作テスト（24 時間以上）
2. メモリリークの確認
3. パフォーマンスの劣化を確認

## 期待される効果

### 対策 1（ULSA M5B 側の修正）を実装した場合

- **コマンド応答時間**: 数 ms（M-BUS 未接続時と同等）
- **NG 102 エラー**: ほぼゼロ
- **リトライ回数**: 0 回（初回で成功）

### 対策 2-5 を実装した場合

- **コマンド応答時間**: 100-500ms（改善されるが、完全には解決しない可能性）
- **NG 102 エラー**: 減少するが、完全には解決しない可能性
- **リトライ回数**: 1-2 回（改善されるが、完全には解決しない可能性）

## 結論

**最も効果的な解決策は、ULSA M5B 側の修正（対策 1）です。**

ULSA M5B の`recvUART`タスクを修正し、ES920LR3 のコマンド送信中は一時停止する機能を追加することで、根本的な解決が期待できます。

現在実装済みの対策（Serial2 のバッファクリアなど）は、一時的な緩和策として有効ですが、根本的な解決には至らない可能性があります。
